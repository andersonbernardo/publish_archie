var uri = "wss://" + window.location.host + "/Notifications";
var socketOpen = false;
var socketId = "";


function CalendarMountMobile() {

    var selectorInput = $("#textInput");
    var myCalendar = CalendarMount("calendarHere");

    var onChangeId = myCalendar.attachEvent("onClick", function (date, state) {
        var message = "Agendamento para: " + myCalendar.getFormatedDate("%d/%m/%y as %H:%i");
        sendMessage(message, "waiting");
        myCalendar.unload();
        selectorInput.val('');
        selectorInput.removeAttr("readonly", "readonly")
        $.modal.close();
    });


    myCalendar.attachEvent("onHide", function () {
        myCalendar.detachObj("textInput");
        selectorInput.val('');
        selectorInput.removeAttr("readonly", "readonly");
        $.modal.close();

    });

    myCalendar.attachEvent("onShow", function () {
        $("#ex1").modal({
            escapeClose: false
        });
    });

    myCalendar.show();

}

function CalendarMountWeb() {

    var selectorInput = $("#textInput");
    var myCalendar = CalendarMount("textInput");

    var onChangeId = myCalendar.attachEvent("onClick", function (date, state) {
        var message = "Agendamento para: " + myCalendar.getFormatedDate("%d/%m/%y as %H:%i");
        sendMessage(message, "waiting");
        myCalendar.unload();
        selectorInput.val('');
        selectorInput.removeAttr("readonly", "readonly")
    });


    myCalendar.attachEvent("onHide", function () {
        myCalendar.detachObj("textInput");
        selectorInput.val('');
        selectorInput.removeAttr("readonly", "readonly");
    });

    myCalendar.show();
}


function CalendarMount(element) {



    dhtmlXCalendarObject.prototype.langData["br"] = {
        dateformat: "%d.%m.%Y",
        monthesFNames: [
            "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho",
            "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
        ],
        monthesSNames: [
            "Jan", "Fev", "Mar", "Abr", "Mai", "Jun",
            "Jul", "Ago", "Set", "Out", "Nov", "Dez"
        ],
        daysFNames: [
            "Domingo", "Segunda", "Terça", "Quarta",
            "Quinta", "Sexta", "Sábado"
        ],
        daysSNames: ["D", "S", "T", "Q", "Q", "S", "S"],
        weekstart: 1,
        weekname: "s"
    };

    dhtmlXCalendarObject.prototype.lang = "br";

    var myCalendar = new dhtmlXCalendarObject(element);

    myCalendar.loadUserLanguage("br");

    //if (detectmob()) {
    //    selectorInput.attr("readonly", "readonly");
    //    var top = ($('div.dhtmlxcalendar_material').offset().top * 0.20);
    //    $('div.dhtmlxcalendar_material').offset({ top: ($('div.dhtmlxcalendar_material').offset().top - top) });

    //}       

    $('div.dhtmlxcalendar_material').css('z-index', 99999);
    $('div.dhtmlxcalendar_material').css('display', 'block');

    return myCalendar;
}

function CalendarStart() {

    var input = document.getElementById("textInput");

    input.addEventListener("keyup", function (event) {

        event.preventDefault();

        if (event.keyCode === 13) {

            var selectorInput = $("#textInput");

            if (selectorInput.val().toLowerCase() == "agendar") {

                selectorInput.val('');

                if (detectmob()) {

                    CalendarMountMobile();

                } else {

                    CalendarMountWeb();
                }

            }

        }
    });
}

function connect() {
    socket = new WebSocket(uri);
    socket.onopen = function (event) {
        socketOpen = true;
        //console.log(event);
    };
    socket.onclose = function (event) {
        socketOpen = false;
    };
    socket.onmessage = function (event) {
        var data = JSON.parse(event.data);
        //console.log(data);
        if (data.messageType == 2) {
            socketId = data.data;

            $.ajax({
                url: "/Chat/ConnectBriefingChat?socketId=" + socketId + "&briefingID=" + briefingId,
                method: 'POST',
            });
        }
        else {
            var parsedData = data.data.split(":");
            var parsedType = parseInt(parsedData.shift());
            var parsedFromId = parseInt(parsedData.shift());
            appendChatMessage(parsedType, parsedFromId, parsedData.join(":"));
        }

    };
    socket.onerror = function (event) {
        //console.log("error: ", event);
    };

    return socket;
}


$(function () {
    var socket = connect();

    CalendarStart();

    var list = $("#messages");
    var button = $("#sendButton");
    var imageButton = $("#chatUpload");


    button.click(sendInput);
    imageButton.change(sendImage);

    window.setInterval(keepAlive, 30000);
});

function sendImage() {
    var data = new FormData();

    var imageInput = $("#chatUpload")[0];

    for (var i = 0; i < imageInput.files.length; i++) {
        data.append("imageFile", imageInput.files[i]);
        //console.log(imageInput.files[i].name);
    }

    data.append("toId", toId);
    data.append("briefingId", briefingId)

    $.ajax({
        url: "/Chat/UploadImage",
        method: 'POST',
        data: data,
        processData: false,
        contentType: false,
        success: function (request) {
            window.location.reload();
        },
        error: function (res, error) {
            alert(res.responseText);
        },

    });

    /*sendRequest('@Url.Action("UploadBriefingPicture", "Project", new {id = @Model.ProjectId })', function(res) {
        imageInput.value = "";
        clearPreview();
    }, data );*/
}

function sendMessage(message, type) {
    //console.log("Sending: " + message);

    $.ajax({
        url: "/Chat/SendMessage?message=" + message + "&toId=" + toId + "&briefingId=" + briefingId + "&type=" + type,
        method: 'GET'
    });

}

function keepAlive() {
    if (!socketOpen) return;

    $.ajax({
        url: "/Chat/KeepAlive?socketId=" + socketId,
        method: 'GET'
    });
}

function sendInput() {
    var input = $("#textInput");

    if (input.val() == "") return;

    sendMessage(input.val(), '');
    input.val("");
}

function appendChatMessage(type, fromId, message) {

    var expression = /[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?/gi;
    var regex = new RegExp(expression);

    if (message.match(regex) && type == 1) {
        message = "<a target='_blank' style='word-break: break-all; text-decoration:underline;' href=" + message + ">" + message + "</a>";
    }

    var dateNow = new Date();

    var dataHtml = '<small style=\"float: right;  font-size: 10px; font-weight: bold; color: #222;\" >' + dateNow.getHours() + ':' + dateNow.getMinutes() + '</small>';

    if (type == 0) {
        //keep alive notification
        return; //to avoid scrolling to the bottom
    }
    else if (type == 1 && fromId != toId) {
        $("#messages").append("<div class='from-left'><p>" + message + "</p>" + dataHtml + "</div>");
    }
    else if (type == 1 && fromId == toId) {
        $("#messages").append("<div class='from-right'><p>" + message + "</p>" + dataHtml + "</div>");
    }
    else if (type == 2) {
        $("#messages").append("<div class='from-system'><p class='doing'>" + message + "</p>" + dataHtml + "</div>");
    }
    else if (type == 3) {
        $("#messages").append("<div class='from-system'><p class='waiting'>" + message + "</p>" + dataHtml + "</div>");
    }
    else if (type == 4) {
        $("#messages").append("<div class='from-system'><p class='notApproved'>" + message + "</p>" + dataHtml + "</div>");
    }
    else if (type == 5) {
        $("#messages").append("<div class='from-system'><p class='done'>" + message + "</p>" + dataHtml + "</div>");
    }
    else if (type == 6) {
        $("#messages").append("<div class='from-system'><p>" + message + "</p>" + dataHtml + "</div>");
    }
    else if (type == 7 && fromId != toId) {
        $("#messages").append("<div class='from-left'><p><img src='" + message + "'/></p>" + dataHtml + "</div>");
    }
    else if (type == 7 && fromId == toId) {
        $("#messages").append("<div class='from-right'><p><img src='" + message + "'/></p>" + dataHtml + "</div>");
    }
    else {
        //$("#messages").append("<div class='updated'><p>" + message + "</p></div>");
    }

    $("#messages").scrollTop($("#messages")[0].scrollHeight);

}

function detectmob() {
    if (navigator.userAgent.match(/Android/i)
        || navigator.userAgent.match(/webOS/i)
        || navigator.userAgent.match(/iPhone/i)
        || navigator.userAgent.match(/iPad/i)
        || navigator.userAgent.match(/iPod/i)
        || navigator.userAgent.match(/BlackBerry/i)
        || navigator.userAgent.match(/Windows Phone/i)
    ) {
        return true;
    }
    else {
        return false;
    }
}